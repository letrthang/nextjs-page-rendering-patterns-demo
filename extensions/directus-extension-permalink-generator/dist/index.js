import{useStores as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as l,inject as a,ref as n,computed as r,onMounted as o,resolveComponent as i,openBlock as s,createElementBlock as c,createVNode as d,withCtx as u,createTextVNode as p}from"vue";const g={class:"permalink-generator"};var f=l({__name:"interface",props:{value:{default:null},disabled:{type:Boolean,default:!1},placeholder:{default:"Click Generate URL to create permalink"},collection:{},field:{},primaryKey:{default:"+"},titleField:{default:"title"},parentRelationField:{default:""},slashAtStart:{default:"/"}},emits:["input"],setup(t,{emit:l}){const f=t,v=l,m=a("api"),h=a("values"),{useNotificationsStore:y}=e(),k=y(),P=n(!1),b=n([]);function F(){return!(!f.parentRelationField||""===f.parentRelationField.trim())}const w=r(()=>f.parentRelationField||""),S=r(()=>{var e;return(null==(e=h.value)?void 0:e.id)||f.primaryKey}),x=r(()=>{var e;return(null==(e=h.value)?void 0:e[f.titleField])||""}),E=r(()=>{if(F()){const e=h.value||{},t=e[w.value];return console.log("ðŸ” Checking parent field:",w.value),console.log("ðŸ“¦ Values object:",e),console.log("ðŸ‘‰ Parent value:",t),t}});function A(e){return e.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}async function C(e,t=new Set,l=!1){var a;if(!e||"+"===e)return[];if(t.has(e))return console.error("âš ï¸ Circular reference detected! Page",e,"is already in the path."),k.add({title:"Circular Reference Error",text:"Circular reference. A page cannot be its own ancestor. Please check the parent relationships.",type:"error",dialog:!0}),[];if(t.add(e),l){const l=A(x.value||""),n=F()?(null==(a=h.value)?void 0:a[w.value])||E.value:void 0;if(console.log("ðŸŽ¯ Using CURRENT UI values - Title:",x.value,"Parent:",n),F()&&n&&n!==e){return[...await C(n,t,!1),l]}return[l]}if(!F())try{const t=await m.get(`/items/${f.collection}/${e}`,{params:{fields:["id",f.titleField]}}),l=A(t.data.data[f.titleField]||"");return console.log("ðŸ“‚ Fetched from DB (no parent field) - Page:",e,"Slug:",l),[l]}catch(e){return console.error("Error fetching page:",e),[]}try{const l=["id",f.titleField];w.value&&l.push(w.value);const a=(await m.get(`/items/${f.collection}/${e}`,{params:{fields:l}})).data.data,n=A(a[f.titleField]||"");if(console.log("ðŸ“‚ Fetched from DB - Page:",e,"Slug:",n,"Parent:",a[w.value]),w.value&&a[w.value]&&a[w.value]!==e){return[...await C(a[w.value],t,!1),n]}return[n]}catch(e){return console.error("Error fetching page:",e),[]}}async function R(){var e,t,l;if(console.group("ðŸ”— Generate Permalink"),console.log("Props:",f),console.log("Primary Key:",f.primaryKey),console.log("Title Field:",f.titleField),console.log("Parent Field:",w.value),console.log("Has Parent Field:",F()),console.log("Current Title:",x.value),console.log("Parent ID:",E.value),console.log("ðŸ“¦ Full Values Object:",h.value),console.log("ðŸ” Direct Parent Access:",null==(e=h.value)?void 0:e[w.value]),function(){const e=[];return b.value.includes(f.titleField)||e.push(f.titleField),F()&&!b.value.includes(w.value)&&e.push(w.value),!(e.length>0&&(k.add({title:"Configuration Error",text:`The following configured fields do not exist in the "${f.collection}" collection: ${e.join(", ")}. Please check the interface configuration.`,type:"error",dialog:!0}),1))}()){P.value=!0;try{if("+"===f.primaryKey){if(console.log("ðŸ†• Creating NEW page"),!x.value)return console.warn("âš ï¸ Title is empty!"),k.add({title:"Title Required",text:`Please enter a value in the "${f.titleField}" field before generating the permalink.`,type:"error",dialog:!0}),P.value=!1,void console.groupEnd();const e=A(x.value);let l=[];const a=F()?(null==(t=h.value)?void 0:t[w.value])||E.value:void 0;console.log("ðŸ” Parent value for path building:",a),F()&&a?(console.log("ðŸ“‚ Building path with parent:",a),l=await C(a,new Set,!1)):console.log("ðŸ“„ No parent field configured or no parent selected - creating top-level permalink"),l.push(e);const n=l.join("/"),r=f.slashAtStart&&""!==f.slashAtStart.trim()?f.slashAtStart+n:n;console.log("âœ… Generated permalink:",r),v("input",r),k.add({title:"Success",text:`Permalink generated: ${r}`,type:"success"})}else{console.log("âœï¸ Editing EXISTING page"),console.log("Building path for page:",S.value);const e=F()?(null==(l=h.value)?void 0:l[w.value])||E.value:void 0;if(F()&&e&&e===S.value)return console.error("âŒ Self-reference detected! Page cannot be its own parent."),k.add({title:"Invalid Parent",text:"A page cannot be set as its own parent. Please select a different parent page or leave it empty.",type:"error",dialog:!0}),P.value=!1,void console.groupEnd();const t=await C(S.value,new Set,!0);console.log("Built path:",t);const a=t.join("/"),n=f.slashAtStart&&""!==f.slashAtStart.trim()?f.slashAtStart+a:a;console.log("âœ… Generated permalink:",n),v("input",n),k.add({title:"Success",text:`Permalink updated: ${n}`,type:"success"})}}catch(e){console.error("âŒ Error generating permalink:",e),k.add({title:"Generation Failed",text:`Failed to generate permalink: ${e instanceof Error?e.message:"Unknown error"}`,type:"error",dialog:!0})}finally{P.value=!1,console.groupEnd()}}else console.groupEnd()}return o(async()=>{try{const e=await m.get(`/fields/${f.collection}`);b.value=e.data.data.map(e=>e.field),console.log("Available fields in collection:",b.value)}catch(e){console.error("Error fetching collection fields:",e)}}),(e,l)=>{const a=i("v-input"),n=i("v-button");return s(),c("div",g,[d(a,{"model-value":t.value,placeholder:t.placeholder,disabled:t.disabled,"onUpdate:modelValue":l[0]||(l[0]=t=>e.$emit("input",t))},null,8,["model-value","placeholder","disabled"]),d(n,{class:"generate-button",onClick:R,loading:P.value,disabled:t.disabled||!S.value,small:""},{default:u(()=>[...l[1]||(l[1]=[p(" Generate URL ",-1)])]),_:1},8,["loading","disabled"])])}}}),v=[],m=[];!function(e,t){if(e&&"undefined"!=typeof document){var l,a=!0===t.prepend?"prepend":"append",n=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(n){var o=v.indexOf(r);-1===o&&(o=v.push(r)-1,m[o]={}),l=m[o]&&m[o][a]?m[o][a]:m[o][a]=i()}else l=i();65279===e.charCodeAt(0)&&(e=e.substring(1)),l.styleSheet?l.styleSheet.cssText+=e:l.appendChild(document.createTextNode(e))}function i(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var l=Object.keys(t.attributes),n=0;n<l.length;n++)e.setAttribute(l[n],t.attributes[l[n]]);var o="prepend"===a?"afterbegin":"beforeend";return r.insertAdjacentElement(o,e),e}}("\n.permalink-generator[data-v-f89da632] {\n  display: flex;\n  gap: 8px;\n  align-items: center;\n}\n.generate-button[data-v-f89da632] {\n  flex-shrink: 0;\n}\n",{});var h=t({id:"permalink-generator",name:"Permalink Generator",description:"Auto-generate permalink based on page hierarchy",icon:"link",component:((e,t)=>{const l=e.__vccOpts||e;for(const[e,a]of t)l[e]=a;return l})(f,[["__scopeId","data-v-f89da632"],["__file","interface.vue"]]),options:({field:e})=>[{field:"titleField",name:"Title Field Name",type:"string",meta:{interface:"input",width:"full",options:{placeholder:"title"}},schema:{default_value:"title"}},{field:"parentRelationField",name:"Parent Page Relation Field",type:"string",meta:{interface:"input",width:"full",options:{placeholder:"parent"}},schema:{default_value:""}},{field:"slashAtStart",name:"URL Prefix",type:"string",meta:{interface:"input",width:"half",options:{placeholder:"Put Prefix Here"}},schema:{default_value:"/"}},{field:"placeholder",name:"Placeholder",type:"string",meta:{interface:"input",width:"full",options:{placeholder:"Click Generate URL to create permalink"}},schema:{default_value:"Click Generate URL to create permalink"}}],types:["string"]});export{h as default};
